var TraderLightChart=TraderLightChart||{};TraderLightChart.core=TraderLightChart.core||{},function(a){a.CHART_GLOABLE_CSS="\n\n\n.trader-light-chart {\n  font-size: 0.5rem;\n}\n.trader-light-chart path.line {\n  fill: none;\n  stroke: #000000;\n  stroke-width: 1;\n}\n.trader-light-chart .axis path,\n.trader-light-chart .axis line {\n  fill: none;\n  stroke: #555555;\n  shape-rendering: crispEdges;\n}\n.trader-light-chart path {\n  fill: none;\n  stroke-width: 1;\n}\n.trader-light-chart path.candle {\n  stroke: #000000;\n  shape-rendering: crispEdges;\n}\n.trader-light-chart path.candle.body {\n  stroke-width: 0;\n  shape-rendering: crispEdges;\n}\n.trader-light-chart path.candle.up {\n  fill: #d75442;\n  stroke: #d75442;\n  shape-rendering: crispEdges;\n}\n.trader-light-chart path.candle.down {\n  fill: #6ba583;\n  stroke: #6ba583;\n  shape-rendering: crispEdges;\n}\n.trader-light-chart path.ohlc {\n  stroke: #000000;\n  stroke-width: 1;\n}\n.trader-light-chart path.ohlc.up {\n  stroke: #d75442;\n}\n.trader-light-chart path.ohlc.down {\n  stroke: #6ba583;\n}\n.trader-light-chart .close.annotation.up path {\n  font-size: 0.5rem;\n  fill: #00AA00;\n}\n.trader-light-chart .ma-0 path.line {\n  stroke: #000000;\n}\n.trader-light-chart .ma-1 path.line {\n  stroke: #2679CB;\n}\n.trader-light-chart .ma-2 path.line {\n  stroke: #FA110F;\n}\n.trader-light-chart .ma-3 path.line {\n  stroke: #00A800;\n}\n.trader-light-chart .ma-4 path.line {\n  stroke: #C0C0C0;\n}\n.trader-light-chart .ma-5 path.line {\n  stroke: #0000FF;\n}\n.trader-light-chart path.volume {\n  fill: #EEEEEE;\n}\n.trader-light-chart .crosshair {\n  cursor: crosshair;\n}\n.trader-light-chart .crosshair path.wire {\n  stroke: #DDDDDD;\n  stroke-dasharray: 1, 1;\n}\n.trader-light-chart .crosshair .axisannotation path {\n  fill: #DDDDDD;\n}\n.trader-light-chart .analysis path,\n.trader-light-chart .analysis circle {\n  stroke: #7E7E7E;\n  stroke-width: 0.8;\n}\n.trader-light-chart .interaction path,\n.trader-light-chart .interaction circle {\n  pointer-events: all;\n}\n.trader-light-chart .interaction .body {\n  cursor: move;\n}\n.trader-light-chart .supstance path {\n  stroke-dasharray: 2, 2;\n}\n.trader-light-chart .supstances .interaction path {\n  pointer-events: all;\n  cursor: ns-resize;\n}\n.trader-light-chart .mouseover .supstance path {\n  stroke-width: 1.5;\n}\n.trader-light-chart .dragging .supstance path {\n  stroke: darkblue;\n}\n\n\n    "}(TraderLightChart.core);var TraderLightChart=TraderLightChart||{};TraderLightChart.core=TraderLightChart.core||{},function(a){a.getContainerWidth=function(){},a.getContainerHeight=function(){},a.classExtend=function(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a,a.superClass=b.prototype,b.prototype.constructor==Object.prototype.constructor&&(b.prototype.constructor=b)},a.insertCSS=function(a){var b=document.createElement("style");b.innerHTML=a,document.body.appendChild(b)},a.insertChartCSSToGloable=function(){a.insertCSS(a.CHART_GLOABLE_CSS)},a.locale=function(a){}}(TraderLightChart.core),TraderLightChart.core.insertChartCSSToGloable(),TraderLightChart.core.locale({decimal:".",thousands:",",grouping:[3],currency:["￥",""],dateTime:"%Y-%m-%d %H:%M:%S",date:"%Y-%m-%d",time:"%H:%M:%S",periods:["AM","PM"],days:["周日","周一","周二","周三","周四","周五","周六"],shortDays:["周日","周一","周二","周三","周四","周五","周六"],months:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],shortMonths:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"]}),TraderLightChart.BaseChart=function(){function a(a){this.margin={top:0,bottom:30,left:50,right:1},this.options={container_id:"trader_light_chart_container",interval:"D",maxVisiableBars:120},_.extend(this.options,a),this.maxVisiableBars=this.options.maxVisiableBars,this.data=[],this.pending=[],this.isReady=!1,this.canReInit=!0,this.supstanceData=[],this.baseDatum=null}return a.prototype._init=function(){},a.prototype._createScale=function(){this.isReady&&(this.xScale=techan.scale.financetime().outerPadding(0),this.yScale=d3.scale.linear(),this.yPercentScale=this.yScale.copy(),this.yScaleOfVolume=d3.scale.linear(),this._setScales())},a.prototype._setScales=function(){this.xScale.range([0,this.containerWidth-this.margin.left-this.margin.right]),this.yScale.range([this.containerHeight-this.margin.top-this.margin.bottom,0]),this.yPercentScale.range([this.containerHeight-this.margin.top-this.margin.bottom,0]),this.yScaleOfVolume.range([this.yScale(0),this.yScale(.4)])},a.prototype._createAxis=function(){this.isReady&&(this.xAxis=d3.svg.axis().scale(this.xScale).orient("bottom"),this.yAxisRight=d3.svg.axis().scale(this.yScale).orient("right"),this.yAxisLeft=d3.svg.axis().scale(this.yScale).orient("left"))},a.prototype._createMainPlot=function(){},a.prototype._createSupstance=function(){this.supstance=techan.plot.supstance().xScale(this.xScale).yScale(this.yScale)},a.prototype.addSupstance=function(a){function b(){c.supstanceData.push(a.price),c._drawSupstances()}var c=this;this._pendingExecute(b)},a.prototype._drawSupstances=function(){var a=this._genSupstanceData(this.data[0],this.data[this.data.length-1]);a.length>0&&this.mainG.select("g.supstances").datum(a).call(this.supstance)},a.prototype._refreshSupstances=function(){var a=this._genSupstanceData(this.data[0],this.data[this.data.length-1]);a.length>0&&this.mainG.select("g.supstances").datum(a).call(this.supstance.refresh)},a.prototype._genSupstanceData=function(a,b){for(var c=[],d=0;d<this.supstanceData.length;d++)c.push({start:a,end:b,value:this.supstanceData[d]});return c},a.prototype._createAxisAnnotation=function(){if(this.isReady){var a=function(a){return"1"===a?d3.time.format("%H:%M"):d3.time.format("%Y-%m-%d")}(this.options.interval);this.timeAnnotation=techan.plot.axisannotation().axis(this.xAxis).format(a).width(65).translate([0,this.containerHeight-this.margin.top-this.margin.bottom]),this.ohlcAnnotationRight=techan.plot.axisannotation().axis(this.yAxisRight).format(d3.format(",.2fs")).translate([this.xScale(1),0]),this.ohlcAnnotationLeft=techan.plot.axisannotation().axis(this.yAxisLeft).format(d3.format(",.2fs")),this.closeAnnotation=techan.plot.axisannotation().axis(this.yAxisRight).accessor(this.accessor).format(d3.format(",.2fs")).translate([this.xScale(1),0])}},a.prototype._createCrossHair=function(){this.isReady&&(this.crosshair=techan.plot.crosshair().xScale(this.xScale).yScale(this.yScale).xAnnotation(this.timeAnnotation).yAnnotation([this.ohlcAnnotationRight,this.ohlcAnnotationLeft]))},a.prototype._initContainer=function(){if(this.containerElement=document.getElementById(this.options.container_id),!(this.containerElement.offsetWidth<=0||this.containerElement.offsetHeight<=0)){this.containerElement.classList.add("trader-light-chart"),this.isReady=!0,this._setChartBasics();var a=this;window.onresize=function(){a._onChartContainerResize()},this.containerSelector=d3.select("body div[id="+this.options.container_id+"]")}},a.prototype._setChartBasics=function(){this.containerWidth=this.containerElement.offsetWidth,this.containerHeight=this.containerElement.offsetHeight,this.containerElement.offsetWidth<360&&this._setMargin({left:30}),this.containerWidth=this.containerWidth-this.margin.left-this.margin.right>10?this.containerWidth:400,this.containerHeight=this.containerHeight-this.margin.top-this.margin.bottom>10?this.containerHeight:300},a.prototype._initMainSvg=function(){if(this.isReady){this.mainSvg=this.containerSelector.append("svg");var a=this.mainSvg.append("defs");this.rect=a.append("clipPath").attr("id","ohlcClip").append("rect").attr("x",0).attr("y",0),this.mainG=this.mainSvg.append("g"),this._setMainSvgSize()}},a.prototype._setMainSvgSize=function(){this.mainSvg.attr("width",this.containerWidth).attr("height",this.containerHeight),this.rect.attr("width",this.containerWidth-this.margin.left-this.margin.right).attr("height",this.containerHeight-this.margin.top-this.margin.bottom),this.mainG.attr("transform","translate("+this.margin.left+","+this.margin.top+")")},a.prototype._conbine=function(){},a.prototype._afterConbine=function(){this._setAxisesSize(),this.canReInit=!1,this._clearPending()},a.prototype._setAxisesSize=function(){this.mainG.select("g.x.axis").attr("transform","translate(0,"+(this.containerHeight-this.margin.top-this.margin.bottom)+")"),this.mainG.select("g.y.axis.right").attr("transform","translate("+this.xScale(1)+",0)"),this.mainG.select("g.y.axis.left").attr("transform","translate(0,0)")},a.prototype.feedData=function(a){for(var b=0;b<a.length;b++){var c=this._pretreatData(a[b]);this.data.push(c)}},a.prototype._bindData=function(){},a.prototype.draw=function(){},a.prototype._dataInVisiable=function(){var a=this._domainInVisiable();return this.data.slice(a[0],a[1])},a.prototype._domainInVisiable=function(){return this.maxVisiableBars>this.data.length?[0,this.data.length]:[this.data.length-this.maxVisiableBars,this.data.length]},a.prototype._bindLineData=function(a,b){var c=a.datum();return c?void c.splice.apply(c,[0,c.length].concat(b)):void a.datum(b)},a.prototype._pretreatData=function(a){return{date:moment(a.date||a.time).toDate(),open:a.open,high:a.high,low:a.low,close:a.close,volume:a.volume}},a.prototype.getBaseDatum=function(){return this.baseDatum?this.baseDatum:this.data[0]},a.prototype.setBaseDatum=function(a){a&&a.high&&a.open&&a.low&&a.close?this.baseDatum=this._pretreatData(a):this.baseDatum=null},a.prototype._onChartContainerResize=function(){this._setChartBasics(),this._setMainSvgSize(),this.draw()},a.prototype._setMargin=function(a){_.extend(this.margin,a)},a.prototype._pendingExecute=function(a){this.isReady?a():this.pending.push(a)},a.prototype._clearPending=function(){for(;this.pending.length>0;){var a=this.pending.shift();a()}},a.prototype.drawBars=function(a){this.feedData(a),this.draw()},a.prototype.drawBar=function(a){this.feedData([a]),this.draw()},a.prototype.reInit=function(){this.canReInit&&(this._init(),this.draw())},a}();var TraderLightChart=TraderLightChart||{};TraderLightChart.LineChart=function(){function a(b){a.superClass.constructor.call(this,b),this.accessor=techan.plot.close().accessor(),this._init()}return TraderLightChart.core.classExtend(a,TraderLightChart.BaseChart),a.prototype._init=function(){this._initContainer(),this._initMainSvg(),this._createScale(),this._createAxis(),this._createMainPlot(),this._createAxisAnnotation(),this._createSupstance(),this._createCrossHair(),this._conbine()},a.prototype._createMainPlot=function(){this.isReady&&(this.mainPlot=techan.plot.close().xScale(this.xScale).yScale(this.yScale),this.accessor=this.mainPlot.accessor(),this.volume=techan.plot.volume().accessor(this.accessor).xScale(this.xScale).yScale(this.yScaleOfVolume))},a.prototype._createAxis=function(){this.isReady&&(this.xAxis=d3.svg.axis().scale(this.xScale).orient("bottom"),this.yAxisRight=d3.svg.axis().scale(this.yScale).orient("right"),this.yAxisLeft=d3.svg.axis().scale(this.yPercentScale).orient("left").tickFormat(d3.format("+.1%")))},a.prototype._conbine=function(){if(this.isReady){var a=this.mainG.append("g").attr("class","ohlc").attr("transform","translate(0,0)");a.append("g").attr("class","volume").attr("clip-path","url(#ohlcClip)"),this._conbineAxises(),a.append("g").attr("class","close").attr("clip-path","url(#ohlcClip)"),this.mainG.append("g").attr("class","close annotation up"),this.mainG.append("g").attr("class","crosshair ohlc"),this.mainG.append("g").attr("class","supstances analysis").attr("clip-path","url(#ohlcClip)"),this._afterConbine()}},a.prototype._conbineAxises=function(){this.mainG.append("g").attr("class","x axis"),this.mainG.append("g").attr("class","y axis right"),this.mainG.append("g").attr("class","y axis left")},a.prototype._bindData=function(){this._bindLineData(this.mainG.select("g.close"),this.data);var a=this.data[this.data.length-1];this.mainG.select("g.close.annotation").datum([a]),this.mainG.select("g.volume").datum(this.data)},a.prototype.draw=function(){this.isReady&&(this._bindData(),this._drawAxises(),this.mainG.select("g.close").call(this.mainPlot),this.mainG.select("g.close.annotation").call(this.closeAnnotation),this.mainG.select("g.volume").call(this.volume),this.mainG.select("g.crosshair.ohlc").call(this.crosshair),this._drawSupstances())},a.prototype._drawAxises=function(){this.xScale.domain(techan.scale.plot.time(this.data).domain()),this.xScale.zoomable().domain(this._domainInVisiable()),this.yScale.domain(techan.scale.plot.ohlc(this._dataInVisiable()).domain()),this.yPercentScale.domain(techan.scale.plot.percent(this.yScale,this.accessor(this.getBaseDatum())).domain()),this.yScaleOfVolume.domain(techan.scale.plot.volume(this._dataInVisiable()).domain()),this.mainG.select("g.x.axis").call(this.xAxis),this.mainG.select("g.y.axis.right").call(this.yAxisRight),this.mainG.select("g.y.axis.left").call(this.yAxisLeft)},a}();var TraderLightChart=TraderLightChart||{};TraderLightChart.CandleChart=function(){function a(b){a.superClass.constructor.call(this,b),this._init(),this.studies=[]}return TraderLightChart.core.classExtend(a,TraderLightChart.BaseChart),a.prototype._init=function(){this.zoomAssociated=!1,this._initContainer(),this._initMainSvg(),this.createBehavior(),this._createScale(),this._createAxis(),this._createMainPlot(),this._createAxisAnnotation(),this._createSupstance(),this._createCrossHair(),this._conbine()},a.prototype.createBehavior=function(){var a=this;this.zoom=d3.behavior.zoom().on("zoom",function(){a.zoomed()})},a.prototype.createIndicators=function(){this.sma=techan.plot.sma().xScale(this.xScale).yScale(this.yScale),this.smaCalculator=techan.indicator.sma().period(10)},a.prototype._createMainPlot=function(){this.isReady&&(this.mainPlot=techan.plot.candlestick().xScale(this.xScale).yScale(this.yScale),this.accessor=this.mainPlot.accessor(),this.volume=techan.plot.volume().accessor(this.accessor).xScale(this.xScale).yScale(this.yScaleOfVolume))},a.prototype._conbine=function(){this.isReady&&(this.ohlcSelection=this.mainG.append("g").attr("class","ohlc").attr("transform","translate(0,0)"),this.ohlcSelection.append("g").attr("class","volume").attr("clip-path","url(#ohlcClip)"),this.ohlcSelection.append("g").attr("class","candlestick").attr("clip-path","url(#ohlcClip)"),this.mainG.append("g").attr("class","x axis"),this.mainG.append("g").attr("class","y axis right"),this.mainG.append("g").attr("class","y axis left"),this.mainG.append("g").attr("class","close annotation up"),this.mainG.append("g").attr("class","crosshair ohlc"),this.mainG.append("g").attr("class","supstances analysis").attr("clip-path","url(#ohlcClip)"),this._afterConbine())},a.prototype._bindData=function(){this.mainG.select("g.candlestick").datum(this.data);var a=this.data[this.data.length-1];this.mainG.select("g.close.annotation").datum([a]),this._bindStudies(),this.mainG.select("g.volume").datum(this.data)},a.prototype.draw=function(){this.isReady&&(this._bindData(),this.xScale.domain(techan.scale.plot.time(this.data).domain()),this.xScale.zoomable().domain(this._domainInVisiable()),this.yScale.domain(techan.scale.plot.ohlc(this._dataInVisiable()).domain()),this.yScaleOfVolume.domain(techan.scale.plot.volume(this._dataInVisiable()).domain()),this.mainG.select("g.x.axis").call(this.xAxis),this.mainG.select("g.y.axis.right").call(this.yAxisRight),this.mainG.select("g.y.axis.left").call(this.yAxisLeft),this.mainG.select("g.candlestick").call(this.mainPlot),this.mainG.select("g.close.annotation").call(this.closeAnnotation),this._drawStudies(),this.mainG.select("g.volume").call(this.volume),this.mainG.select("g.crosshair.ohlc").call(this.crosshair).call(this.zoom),this._drawSupstances(),this.zoomAssociated||(this.zoom.x(this.xScale.zoomable()).y(this.yScale),this.zoomAssociated=!0))},a.prototype.zoomed=function(a){this.zoom.translate(),this.mainG.select("g.x.axis").call(this.xAxis),this.mainG.select("g.y.axis.right").call(this.yAxisRight),this.mainG.select("g.y.axis.left").call(this.yAxisLeft),this.mainG.select("g.candlestick").call(this.mainPlot.refresh),this.mainG.select("g.close.annotation").call(this.closeAnnotation.refresh),this._zoomStudies(),this.mainG.select("g.volume").call(this.volume.refresh),this.mainG.select("g.crosshair.ohlc").call(this.crosshair.refresh),this._refreshSupstances()},a.prototype.addStudy=function(a,b,c){function d(){if("Moving Average"==a){var c=techan.plot.sma().xScale(e.xScale).yScale(e.yScale),d=techan.indicator.sma().period(b[0]),f=e.studies.length,g="ma-"+f;e.ohlcSelection.append("g").attr("class","indicator sma "+g).attr("clip-path","url(#ohlcClip)");var h=e.mainG.select("g .sma."+g);e.studies.push([h,c,d])}}var e=this;this._pendingExecute(d)},a.prototype._bindStudies=function(){for(var a=0;a<this.studies.length;a++){var b=this.studies[a][0],c=(this.studies[a][1],this.studies[a][2]);this._bindLineData(b,c(this.data))}},a.prototype._drawStudies=function(){for(var a=0;a<this.studies.length;a++){var b=this.studies[a][0],c=this.studies[a][1];this.studies[a][2];b.call(c)}},a.prototype._zoomStudies=function(){for(var a=0;a<this.studies.length;a++){var b=this.studies[a][0],c=this.studies[a][1];this.studies[a][2];b.call(c.refresh)}},a}();