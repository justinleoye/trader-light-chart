var TraderLightChart=TraderLightChart||{};TraderLightChart.core=TraderLightChart.core||{},function(a){a.CHART_GLOABLE_CSS="\n\n\n\npath.line {\n    fill: none;\n    stroke: #000000;\n    stroke-width: 1;\n}\n\n.axis path,\n.axis line {\n    fill: none;\n    stroke: #000;\n    shape-rendering: crispEdges;\n}\n\npath {\n    fill: none;\n    stroke-width: 1;\n}\n\npath.candle {\n    stroke: #000000;\n}\n\npath.candle.body {\n    stroke-width: 0;\n}\n\npath.candle.up {\n    fill: #00AA00;\n    stroke: #00AA00;\n}\n\npath.candle.down {\n    fill: #FF0000;\n    stroke: #FF0000;\n}\n\npath.ohlc {\n    stroke: #000000;\n    stroke-width: 1;\n}\n\npath.ohlc.up {\n    stroke: #00AA00;\n}\n\npath.ohlc.down {\n    stroke: #FF0000;\n}\n\n.close.annotation.up path {\n    fill: #00AA00;\n}\n\n.ma-0 path.line {\n    stroke: #1f77b4;\n}\n\n.ma-1 path.line {\n    stroke: #aec7e8;\n}\n\npath.volume {\n    fill: #EEEEEE;\n}\n\n.crosshair {\n    cursor: crosshair;\n}\n\n.crosshair path.wire {\n    stroke: #DDDDDD;\n    stroke-dasharray: 1, 1;\n}\n\n.crosshair .axisannotation path {\n    fill: #DDDDDD;\n}\n\n\n\n    "}(TraderLightChart.core),function(){function a(a){var b=a.__resizeTriggers__,c=b.firstElementChild,d=b.lastElementChild,e=c.firstElementChild;d.scrollLeft=d.scrollWidth,d.scrollTop=d.scrollHeight,e.style.width=c.offsetWidth+1+"px",e.style.height=c.offsetHeight+1+"px",c.scrollLeft=c.scrollWidth,c.scrollTop=c.scrollHeight}function b(a){return a.offsetWidth!=a.__resizeLast__.width||a.offsetHeight!=a.__resizeLast__.height}function c(c){var d=this;a(this),this.__resizeRAF__&&h(this.__resizeRAF__),this.__resizeRAF__=g(function(){b(d)&&(d.__resizeLast__.width=d.offsetWidth,d.__resizeLast__.height=d.offsetHeight,d.__resizeListeners__.forEach(function(a){a.call(d,c)}))})}function d(){if(!f){var a=(s?s:"")+".resize-triggers { "+(t?t:"")+'visibility: hidden; opacity: 0; } .resize-triggers, .resize-triggers > div, .contract-trigger:before { content: " "; display: block; position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden; } .resize-triggers > div { background: #eee; overflow: auto; } .contract-trigger:before { width: 200%; height: 200%; }',b=document.head||document.getElementsByTagName("head")[0],c=document.createElement("style");c.type="text/css",c.styleSheet?c.styleSheet.cssText=a:c.appendChild(document.createTextNode(a)),b.appendChild(c),f=!0}}var e=document.attachEvent,f=!1;if(!e){var g=function(){var a=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(a){return window.setTimeout(a,20)};return function(b){return a(b)}}(),h=function(){var a=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.clearTimeout;return function(b){return a(b)}}(),i=!1,j="animation",k="",l="animationstart",m="Webkit Moz O ms".split(" "),n="webkitAnimationStart animationstart oAnimationStart MSAnimationStart".split(" "),o="",p=document.createElement("fakeelement");if(void 0!==p.style.animationName&&(i=!0),i===!1)for(var q=0;q<m.length;q++)if(void 0!==p.style[m[q]+"AnimationName"]){o=m[q],j=o+"Animation",k="-"+o.toLowerCase()+"-",l=n[q],i=!0;break}var r="resizeanim",s="@"+k+"keyframes "+r+" { from { opacity: 0; } to { opacity: 0; } } ",t=k+"animation: 1ms "+r+"; "}window.addResizeListener=function(b,f){e?b.attachEvent("onresize",f):(b.__resizeTriggers__||("static"==getComputedStyle(b).position&&(b.style.position="relative"),d(),b.__resizeLast__={},b.__resizeListeners__=[],(b.__resizeTriggers__=document.createElement("div")).className="resize-triggers",b.__resizeTriggers__.innerHTML='<div class="expand-trigger"><div></div></div><div class="contract-trigger"></div>',b.appendChild(b.__resizeTriggers__),a(b),b.addEventListener("scroll",c,!0),l&&b.__resizeTriggers__.addEventListener(l,function(c){c.animationName==r&&a(b)})),b.__resizeListeners__.push(f))},window.removeResizeListener=function(a,b){e?a.detachEvent("onresize",b):(a.__resizeListeners__.splice(a.__resizeListeners__.indexOf(b),1),a.__resizeListeners__.length||(a.removeEventListener("scroll",c),a.__resizeTriggers__=!a.removeChild(a.__resizeTriggers__)))}}();var TraderLightChart=TraderLightChart||{};TraderLightChart.core=TraderLightChart.core||{},function(a){a.getContainerWidth=function(){},a.getContainerHeight=function(){},a.classExtend=function(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a,a.superClass=b.prototype,b.prototype.constructor==Object.prototype.constructor&&(b.prototype.constructor=b)},a.insertCSS=function(a){var b=document.createElement("style");b.innerHTML=a,document.body.appendChild(b)},a.insertChartCSSToGloable=function(){a.insertCSS(a.CHART_GLOABLE_CSS)}}(TraderLightChart.core),TraderLightChart.core.insertChartCSSToGloable(),TraderLightChart.BaseChart=function(){function a(a){this.margin={top:20,bottom:30,left:50,right:50},this.options={container_id:"trader_light_chart_container",interval:"D"},_.extend(this.options,a),this.data=[],this.isConbineReady=!1,this.pending=[]}return a.prototype.init=function(){},a.prototype.createScale=function(){console.log("createScale"),this.xScale=techan.scale.financetime().outerPadding(0),this.yScale=d3.scale.linear(),this.yScaleOfVolume=d3.scale.linear(),this.setScales()},a.prototype.setScales=function(){this.xScale.range([0,this.containerWidth-this.margin.left-this.margin.right]),this.yScale.range([this.containerHeight-this.margin.top-this.margin.bottom,0]),this.yScaleOfVolume.range([this.yScale(0),this.yScale(.2)])},a.prototype.createAxis=function(){console.log("createAxis"),this.xAxis=d3.svg.axis().scale(this.xScale).orient("bottom"),this.yAxis=d3.svg.axis().scale(this.yScale).orient("right"),this.volumeAxis=d3.svg.axis().scale(this.yScaleOfVolume).orient("right").ticks(3).tickFormat(d3.format(",.3s"))},a.prototype.createMainPlot=function(){},a.prototype.createAxisAnnotation=function(){this.timeAnnotation=techan.plot.axisannotation().axis(this.xAxis).format(d3.time.format("%Y-%m-%d")).width(65).translate([0,this.containerHeight-this.margin.top-this.margin.bottom]),this.ohlcAnnotation=techan.plot.axisannotation().axis(this.yAxis).format(d3.format(",.2fs")).translate([this.xScale(1),0]),this.closeAnnotation=techan.plot.axisannotation().axis(this.yAxis).accessor(this.accessor).format(d3.format(",.2fs")).translate([this.xScale(1),0]),this.volumeAnnotation=techan.plot.axisannotation().axis(this.volumeAxis).width(35)},a.prototype.createCrossHair=function(){this.crosshair=techan.plot.crosshair().xScale(this.xScale).yScale(this.yScale).xAnnotation(this.timeAnnotation).yAnnotation([this.ohlcAnnotation,this.volumeAnnotation])},a.prototype.initContainer=function(){console.log("initContainer"),this.containerElement=document.getElementById(this.options.container_id),this.setChartBasics();var a=this,b=function(){a.pendingExecute(function(){a.onChartContainerResize()})};this._addWatchContainer(b),this.containerSelector=d3.select("body div[id="+this.options.container_id+"]"),this.maxVisiableBars=120},a.prototype.setChartBasics=function(){this.containerWidth=this.containerElement.offsetWidth,this.containerHeight=this.containerElement.offsetHeight;var a=this.containerElement.scrollWidth,b=this.containerElement.clientWidth;console.log("offsetWidth: "+this.containerWidth+" ,offsetHeight: "+this.containerHeight),console.log("scrollWidth: "+a),console.log("clientWidth: "+b),this.containerWidth=this.containerWidth-this.margin.left-this.margin.right>10?this.containerWidth:400,this.containerHeight=this.containerHeight-this.margin.top-this.margin.bottom>10?this.containerHeight:300,console.log("containerWidth: "+this.containerWidth+" ,containerHeight: "+this.containerHeight)},a.prototype.initMainSvg=function(){console.log("initMainSvg"),this.mainSvg=this.containerSelector.append("svg");var a=this.mainSvg.append("defs");this.rect=a.append("clipPath").attr("id","ohlcClip").append("rect").attr("x",0).attr("y",0),this.mainG=this.mainSvg.append("g"),this.setMainSvgSize()},a.prototype.setMainSvgSize=function(){this.mainSvg.attr("width",this.containerWidth).attr("height",this.containerHeight),this.rect.attr("width",this.containerWidth-this.margin.left-this.margin.right).attr("height",this.containerHeight-this.margin.top-this.margin.bottom),this.mainG.attr("transform","translate("+this.margin.left+","+this.margin.top+")")},a.prototype.conbine=function(){},a.prototype.setAxisesSize=function(){this.mainG.select("g.x.axis").attr("transform","translate(0,"+(this.containerHeight-this.margin.top-this.margin.bottom)+")"),this.mainG.select("g.y.axis").attr("transform","translate("+this.xScale(1)+",0)")},a.prototype.afterConbine=function(){this.clearPending(),this.isConbineReady=!0},a.prototype._addWatchContainer=function(a){function b(){console.log("watchContainerSize"),this.watchContainer&&setTimeout(function(){this.containerElement.offsetWidth!=c?a():b()},300)}this.watchContainer=!0;var c=this.containerElement.offsetWidth;c>0||b()},a.prototype._removeWatchWatchContainer=function(){this.watchContainer=!1},a.prototype.clearPending=function(){for(;this.pending.length>0;){var a=this.pending.shift();a()}},a.prototype.pendingExecute=function(a){this.isConbineReady?a():this.pending.push(a)},a.prototype.feedData=function(a){console.log("feedData");for(var b=0;b<a.length;b++){var c={date:moment(a[b].date||a[b].time).toDate(),open:a[b].open,high:a[b].high,low:a[b].low,close:a[b].close,volume:a[b].volume};this.data.push(c)}console.log("data:",this.data)},a.prototype.bindData=function(){},a.prototype.draw=function(){},a.prototype.dataInVisiable=function(){var a=this.domainInVisiable();return this.data.slice(a[0],a[1])},a.prototype.domainInVisiable=function(){return this.maxVisiableBars>this.data.length?[0,this.data.length]:[this.data.length-this.maxVisiableBars,this.data.length]},a.prototype.bindLineData=function(a,b){console.log("refreshIndicator");var c=a.datum();return c?(console.log("data len before bind:",c.length),c.splice.apply(c,[0,c.length].concat(b)),void console.log("data len after bind:",c.length)):void a.datum(b)},a.prototype.onChartContainerResize=function(){console.log("on resize"),console.log("onChartContainerResize"),this.setChartBasics(),this.setMainSvgSize(),this.draw()},a.prototype.drawBars=function(a){this.feedData(a),this.draw()},a.prototype.drawBar=function(a){this.feedData([a]),this.draw()},a}();var TraderLightChart=TraderLightChart||{};TraderLightChart.LineChart=function(){function a(b){a.superClass.constructor.call(this,b),this.init()}return TraderLightChart.core.classExtend(a,TraderLightChart.BaseChart),a.prototype.init=function(){console.log("init"),this.initContainer(),this.initMainSvg(),this.createScale(),this.createAxis(),this.createMainPlot(),this.createAxisAnnotation(),this.createCrossHair(),this.conbine()},a.prototype.createMainPlot=function(){console.log("createMainPlot"),this.mainPlot=techan.plot.close().xScale(this.xScale).yScale(this.yScale),this.accessor=this.mainPlot.accessor(),this.volume=techan.plot.volume().accessor(this.accessor).xScale(this.xScale).yScale(this.yScaleOfVolume)},a.prototype.conbine=function(){console.log("conbine");var a=this.mainG.append("g").attr("class","ohlc").attr("transform","translate(0,0)");a.append("g").attr("class","volume").attr("clip-path","url(#ohlcClip)"),a.append("g").attr("class","close").attr("clip-path","url(#ohlcClip)"),this.mainG.append("g").attr("class","x axis"),this.mainG.append("g").attr("class","y axis"),this.mainG.append("g").attr("class","close annotation up"),this.mainG.append("g").attr("class","volume axis"),this.mainG.append("g").attr("class","crosshair ohlc"),this.setAxisesSize()},a.prototype.bindData=function(){console.log("bindData"),this.bindLineData(this.mainG.select("g.close"),this.data);var a=this.data[this.data.length-1];console.log("lastDatum:",a),this.mainG.select("g.close.annotation").datum([a]),this.mainG.select("g.volume").datum(this.data)},a.prototype.draw=function(){this.bindData(),console.log("draw"),this.xScale.domain(techan.scale.plot.time(this.data).domain()),this.xScale.zoomable().domain(this.domainInVisiable()),this.yScale.domain(techan.scale.plot.ohlc(this.dataInVisiable()).domain()),this.yScaleOfVolume.domain(techan.scale.plot.volume(this.dataInVisiable()).domain()),this.mainG.select("g.x.axis").call(this.xAxis),this.mainG.select("g.y.axis").call(this.yAxis),this.mainG.select("g.volume.axis").call(this.volumeAxis),this.mainG.select("g.close").call(this.mainPlot),this.mainG.select("g.close.annotation").call(this.closeAnnotation),this.mainG.select("g.volume").call(this.volume),this.mainG.select("g.crosshair.ohlc").call(this.crosshair),this.afterConbine()},a}();var TraderLightChart=TraderLightChart||{};TraderLightChart.CandleChart=function(){function a(b){a.superClass.constructor.call(this,b),this.init()}return TraderLightChart.core.classExtend(a,TraderLightChart.BaseChart),a.prototype.init=function(){console.log("init"),this.zoomAssociated=!1,this.initContainer(),this.initMainSvg(),this.createBehavior(),this.createScale(),this.createAxis(),this.createIndicators(),this.createMainPlot(),this.createAxisAnnotation(),this.createCrossHair(),this.conbine()},a.prototype.createBehavior=function(){var a=this;this.zoom=d3.behavior.zoom().on("zoom",function(){a.zoomed()})},a.prototype.createIndicators=function(){this.sma=techan.plot.sma().xScale(this.xScale).yScale(this.yScale),this.smaCalculator=techan.indicator.sma().period(10)},a.prototype.createMainPlot=function(){console.log("createMainPlot"),this.mainPlot=techan.plot.ohlc().xScale(this.xScale).yScale(this.yScale),this.accessor=this.mainPlot.accessor(),this.volume=techan.plot.volume().accessor(this.accessor).xScale(this.xScale).yScale(this.yScaleOfVolume)},a.prototype.conbine=function(){console.log("conbine");var a=this.mainG.append("g").attr("class","ohlc").attr("transform","translate(0,0)");a.append("g").attr("class","volume").attr("clip-path","url(#ohlcClip)"),a.append("g").attr("class","candlestick").attr("clip-path","url(#ohlcClip)"),a.append("g").attr("class","indicator sma ma-0").attr("clip-path","url(#ohlcClip)"),this.mainG.append("g").attr("class","x axis"),this.mainG.append("g").attr("class","y axis"),this.mainG.append("g").attr("class","close annotation up"),this.mainG.append("g").attr("class","volume axis"),this.mainG.append("g").attr("class","crosshair ohlc"),this.setAxisesSize()},a.prototype.bindData=function(){console.log("bindData"),this.mainG.select("g.candlestick").datum(this.data);var a=this.data[this.data.length-1];console.log("lastDatum:",a),this.mainG.select("g.close.annotation").datum([a]),this.bindLineData(this.mainG.select("g.sma.ma-0"),this.smaCalculator(this.data)),this.mainG.select("g.volume").datum(this.data)},a.prototype.draw=function(){this.bindData(),console.log("draw"),this.xScale.domain(techan.scale.plot.time(this.data).domain()),this.xScale.zoomable().domain(this.domainInVisiable()),this.yScale.domain(techan.scale.plot.ohlc(this.dataInVisiable()).domain()),this.yScaleOfVolume.domain(techan.scale.plot.volume(this.dataInVisiable()).domain()),this.mainG.select("g.x.axis").call(this.xAxis),this.mainG.select("g.y.axis").call(this.yAxis),this.mainG.select("g.volume.axis").call(this.volumeAxis),this.mainG.select("g.candlestick").call(this.mainPlot),this.mainG.select("g.close.annotation").call(this.closeAnnotation),this.mainG.select("g .sma.ma-0").call(this.sma),this.mainG.select("g.volume").call(this.volume),this.mainG.select("g.crosshair.ohlc").call(this.crosshair).call(this.zoom),this.zoomAssociated||(console.log("zoomAssociated"),console.log("zoomable:",this.xScale.zoomable()),console.log("zoomable:",this.xScale.zoomable()),this.zoom.x(this.xScale.zoomable()).y(this.yScale),this.zoomAssociated=!0),this.afterConbine()},a.prototype.zoomed=function(a){console.log("zoomed"),this.zoom.translate(),this.mainG.select("g.x.axis").call(this.xAxis),this.mainG.select("g.y.axis").call(this.yAxis),this.mainG.select("g.volume.axis").call(this.volumeAxis),this.mainG.select("g.candlestick").call(this.mainPlot.refresh),this.mainG.select("g.close.annotation").call(this.closeAnnotation.refresh),this.mainG.select("g .sma.ma-0").call(this.sma.refresh),this.mainG.select("g.volume").call(this.volume.refresh),this.mainG.select("g.crosshair.ohlc").call(this.crosshair.refresh)},a}();